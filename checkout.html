<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>QuickBite | Checkout</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link rel="stylesheet" href="assets/css/styles.css" />
</head>
<body>

  <!-- Session check: redirect to login if not logged in or session expired -->
  <script>
    const isLoggedIn = localStorage.getItem("isLoggedIn") === "true";
    const loginTime = parseInt(localStorage.getItem("loginTime"));
    const sessionLimit = 15 * 60 * 1000;

    if (!isLoggedIn || isNaN(loginTime) || (Date.now() - loginTime > sessionLimit)) {
      localStorage.clear();
      window.location.href = "login.html";
    }

    // New: Prevent checkout if cart is empty
    const tempCart = JSON.parse(localStorage.getItem("cart")) || [];
    if (!tempCart || tempCart.length === 0) {
      alert("Your cart is empty. Please add items before checking out.");
      window.location.href = "cart.html";
    }
  </script>

  <!-- Navbar -->
  <nav class="navbar navbar-dark bg-dark px-3">
    <a class="navbar-brand d-flex align-items-center gap-2" href="index.html">
      <span style="font-size: 1.3rem;">üçî</span>
      <span class="fw-bold text-light">QuickBite</span>
    </a>
    <div class="ms-auto d-flex align-items-center gap-2" id="navButtons"></div>
  </nav>

  <!-- Checkout Content -->
  <div class="container my-5">
    <h2 class="mb-4">üßæ Order Summary</h2>
    <div id="checkoutItems" class="row"></div>
    <hr />

    <h5 class="mb-3">Select Payment Method</h5>
    <div class="btn-group w-100 mb-3" role="group" aria-label="Payment options">
      <input type="radio" class="btn-check" name="paymentMethod" id="visa" autocomplete="off" value="Visa">
      <label class="btn btn-outline-primary" for="visa">üí≥ Visa</label>

      <input type="radio" class="btn-check" name="paymentMethod" id="cash" autocomplete="off" value="Cash">
      <label class="btn btn-outline-success" for="cash">üíµ Cash</label>

      <input type="radio" class="btn-check" name="paymentMethod" id="beans" autocomplete="off" value="Magic Beans">
      <label class="btn btn-outline-warning" for="beans">ü´ò Magic Beans</label>

      <input type="radio" class="btn-check" name="paymentMethod" id="crypto" autocomplete="off" value="Crypto">
      <label class="btn btn-outline-info" for="crypto">ü™ô Crypto</label>
    </div>

    <div class="text-end">
      <h4>Total: $<span id="checkoutTotal">0.00</span></h4>
      <button class="btn btn-success mt-3" onclick="confirmOrder()">Confirm Order</button>
    </div>
  </div>

  <!-- Thank You Modal -->
  <div class="modal fade" id="thankYouModal" tabindex="-1" aria-labelledby="thankYouModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content text-center">
        <div class="modal-header">
          <h5 class="modal-title" id="thankYouModalLabel">üéâ Order Placed!</h5>
        </div>
        <div class="modal-body">
          <p>Thanks for ordering with QuickBite! Your food is being prepared.</p>
        </div>
        <div class="modal-footer justify-content-center">
          <a href="index.html" class="btn btn-primary">Return Home</a>
        </div>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const userEmail = localStorage.getItem("userEmail");
    const nav = document.getElementById("navButtons");
    const cart = JSON.parse(localStorage.getItem("cart")) || [];
    const checkoutContainer = document.getElementById("checkoutItems");
    const checkoutTotal = document.getElementById("checkoutTotal");

    if (isLoggedIn && userEmail) {
      nav.innerHTML = `
        <span class="text-light small">üë§ ${userEmail}</span>
        <a href="menu.html" class="btn btn-outline-light btn-sm">Menu</a>
        <a href="cart.html" class="btn btn-outline-warning btn-sm">Cart (<span id="cartCount">0</span>)</a>
        <button onclick="logout()" class="btn btn-outline-danger btn-sm">Logout</button>
      `;
    }

    function logout() {
      localStorage.clear();
      window.location.href = "index.html";
    }

    function renderCheckout() {
      checkoutContainer.innerHTML = "";
      let total = 0;

      if (cart.length === 0) {
        checkoutContainer.innerHTML = "<p>Your cart is empty.</p>";
        checkoutTotal.textContent = "0.00";
        return;
      }

      cart.forEach(item => {
        const subtotal = item.quantity * item.price;
        total += subtotal;

        const col = document.createElement("div");
        col.className = "col-md-6 mb-3";
        col.innerHTML = `
          <div class="card h-100">
            <div class="row g-0">
              <div class="col-4">
                <img src="${item.image}" class="img-fluid rounded-start" alt="${item.name}">
              </div>
              <div class="col-8">
                <div class="card-body">
                  <h5 class="card-title">${item.name}</h5>
                  <p class="card-text">Qty: ${item.quantity} @ $${item.price.toFixed(2)}</p>
                  <p class="card-text fw-bold">Subtotal: $${subtotal.toFixed(2)}</p>
                </div>
              </div>
            </div>
          </div>
        `;
        checkoutContainer.appendChild(col);
      });

      checkoutTotal.textContent = total.toFixed(2);
    }

    function updateCartCount() {
      const count = cart.reduce((sum, item) => sum + item.quantity, 0);
      const countSpan = document.getElementById("cartCount");
      if (countSpan) countSpan.textContent = count;
    }

    function confirmOrder() {
      const selected = document.querySelector('input[name="paymentMethod"]:checked');
      if (!selected) {
        alert("Please select a payment method.");
        return;
      }

      const method = selected.value;
      localStorage.removeItem("cart");

      const modalText = document.querySelector("#thankYouModal .modal-body p");
      modalText.textContent = `Thanks for ordering with QuickBite! Your payment via ${method} was received. Your food is on the way!`;

      const modal = new bootstrap.Modal(document.getElementById("thankYouModal"));
      modal.show();
    }

    renderCheckout();
    updateCartCount();
  </script>
</body>
</html>
